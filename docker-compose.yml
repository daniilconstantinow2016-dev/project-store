services:
  # 1. –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö (—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º Healthcheck)
  postgres:
    image: postgres:15
    container_name: cyber_postgres
    environment:
      POSTGRES_USER: cyber_user
      POSTGRES_PASSWORD: cyber_password
      POSTGRES_DB: cyber_market_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ç–∏–ª–∏—Ç–æ–π pg_isready (–æ–Ω–∞ –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ –æ–±—Ä–∞–∑)
      test: ["CMD-SHELL", "pg_isready -U cyber_user -d cyber_market_db"]
      interval: 10s       # –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–∑ –≤ 10 —Å–µ–∫—É–Ω–¥ (—Ä–µ–∂–µ, —á–µ–º —Ä–∞–Ω—å—à–µ)
      timeout: 5s         # –ñ–¥–∞—Ç—å –æ—Ç–≤–µ—Ç–∞ 5 —Å–µ–∫—É–Ω–¥
      retries: 5          # –ï—Å–ª–∏ 5 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ –æ—à–∏–±–∫–∞ ‚Äî —Ç–æ–≥–¥–∞ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ unhealthy
      start_period: 30s   # üëà –ì–õ–ê–í–ù–û–ï: –ü–µ—Ä–≤—ã–µ 30 —Å–µ–∫ –Ω–µ —Å—á–∏—Ç–∞–µ–º –æ—à–∏–±–∫–∏ (–¥–∞–µ–º –ø—Ä–æ—Å–Ω—É—Ç—å—Å—è)

  # 2. –ê–¥–º–∏–Ω–∫–∞
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: cyber_pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: root
    ports:
      - "5050:80"
    depends_on:
      postgres:
        condition: service_healthy # –ñ–¥–µ–º, –ø–æ–∫–∞ –±–∞–∑–∞ —Å–∫–∞–∂–µ—Ç "–Ø –∑–¥–æ—Ä–æ–≤–∞"

  # 3. –¢–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  app:
    container_name: cyber_app
    build: ./backend/services/catalog
    ports:
      - "8080:8080"
    environment:
      DATABASE_URL: postgres://cyber_user:cyber_password@postgres:5432/cyber_market_db
      HTTP_PORT: :8080
    depends_on:
      postgres:
        condition: service_healthy # –ñ–¥–µ–º, –ø–æ–∫–∞ –±–∞–∑–∞ —Å–∫–∞–∂–µ—Ç "–Ø –∑–¥–æ—Ä–æ–≤–∞"

volumes:
  postgres_data:
